name: k8sUI_$(SourceBranchName)_$(Date:MMMd)$(Rev:.r)

# PR trigger
pr:
- master

# CI trigger
trigger:
- master

jobs:
- job: 'Build_Test_Publish'
  timeoutInMinutes: 20
  cancelTimeoutInMinutes: 2
  pool:
    name: 'Hosted VS2017'
    demands: npm

  steps:
    - task: NodeTool@0
      displayName: 'Use Node version'
      inputs:
        versionSpec: '8.4'

    - task: Npm@1
      displayName: 'npm install'
      inputs:
        command: install

    - task: Npm@1
      displayName: 'Build source'
      inputs:
        command: custom
        customCommand: 'run build'

    - task: Npm@1
      displayName: 'Run UTs'
      inputs:
        command: custom
        customCommand: 'run test'

    - task: PublishTestResults@2
      condition: succeededOrFailed()
      displayName: 'Publish L0 UTs'
      inputs:
        testRunner: JUnit
        testResultsFiles: '**/jest-l0-uts.xml'
        testRunTitle: 'L0 UTs'

    - task: ArchiveFiles@2
      displayName: 'Archive dist folder'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      inputs:
        rootFolderOrFile: '$(System.DefaultWorkingDirectory)/dist'
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildNumber).zip'

    - task: ArchiveFiles@2
      displayName: 'Archive License to dist folder'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      inputs:
        rootFolderOrFile: LICENSE.txt
        includeRootFolder: false
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildNumber).zip'
        replaceExistingArchive: false

    - task: ArchiveFiles@2
      displayName: 'Archive README to dist folder'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      inputs:
        rootFolderOrFile: README.md
        includeRootFolder: false
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildNumber).zip'
        replaceExistingArchive: false

    - task: ArchiveFiles@2
      displayName: 'Archive package to dist folder'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      inputs:
        rootFolderOrFile: package.json
        includeRootFolder: false
        archiveFile: '$(Build.ArtifactStagingDirectory)/$(Build.BuildNumber).zip'
        replaceExistingArchive: false

    - task: PublishBuildArtifacts@1
      displayName: 'Publish Artifact: dist'
      condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/master'))
      inputs:
        ArtifactName: dist
